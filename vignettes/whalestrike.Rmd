---
title: "Using the whalestrike package"
author: "Dan Kelley"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    fig_caption: yes
    fig_width: 5
    fig_height: 5
    dpi: 72
    dev.args: list(pointsize=11)
vignette: >
  %\VignetteIndexEntry{Using the whalestrike package}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

<!-- HOW TO BUILD THE VIGNETTE. -->
<!-- 1. edit this file in vignettes/whalestrike.Rmd -->
<!-- 2. run devtools::build_vignettes() -->
<!-- 3. build the package -->


```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

**Abstract.** This vignette explains the basics of using the whalestrike
package to simulate the collision of a ship with a whale.

# Introduction

This package solves Newton's second law for a simple model of a ship colliding
with a whale. This is a stripped-down model that does not attempt to simulate
the biomechanical interactions that can be simulated in finite-element
treatments such as that of Raymond (2007).  The goal is to establish a
convenient framework for rapid computation of impacts in a wide variety of
conditions. The model runs quickly enough to keep up with mouse movements to
select conditions, in a companion R shiny app. That app lets the user see the
effects of changing contact area, ship speed, etc., as a way to build intuition
for scenarios ranging from collision with a slow-moving fishing boat to
collision with a thin dagger-board of a much swifter racing sailboat. Another
advantage of the simple formulation is that it makes it easy to modify various
dynamical and biomechanical parameters, to add new forces, and to explore a
range of criteria for whale damage.

The documentation for [strike](../help/strike) provides an example of using the
main functions of this package, and so it is a good place to start. A companion
manuscript is intended to provide more detail about the analysis and the
context.

# Examples

## Overview plot

The following shows how to run a simulation and produce a simple summary plot.
(Setting the second argument of `plot()` gives access to about a dozen plot
types.) The top-left panel shows position of ship as a dashed curve, while the
whale is indicated with three curves, the top being an imagined point mass in
the whale interior, the one below it being the interface between sublayer and
blubber, and the one below that being the whale skin. (Actually, the skin is
so thin that what seems to be a thick line is actually two lines.)

The bottom-left panel shows a cross section of whale skin, blubber and
sublayer. Cross-hatching is used to indicate stresses (force/area values) that
exceed the strength of a given region; in this example, the sublayer exceeds
the stated strength at about 0.5s into the simulation.

The top-right panel shows an indication of injury for each component. Gray
lines indicate that the crition is met halfway, and thick lines indicate that
the criterion is exceeded. Again, this is an indication of damage to the
sublayer, but we see also a suggestion of possible damage to the blubber.

The bottom-right panel shows the values of this simulation, so of which were
calculated by `parameters()`, e.g. the whale mass `mw` and area `Sw` were
computed from the supplied value of `lw`, the whale length.

```{r results="hide"}
library(whalestrike)
t <- seq(0, 1, length.out=500)
state <- c(xs=-2.5, vs=10*0.5144, xw=0, vw=0) # 10 knot ship
parms <- parameters(ms=20e3,
                    impactWidth=0.5, impactHeight=1,
                    lw=10,
                    alpha=0.025, Ealpha=2e7, theta=45,
                    beta=0.25, Ebeta=6e5,
                    gamma=0.5, Egamma=4e5)
sol <- strike(t, state, parms)
par(mfcol=c(2, 2), mar=c(2, 3, 0.5, 0.5), mgp=c(2, 0.7, 0), cex=0.7)
plot(sol)
```

## Acceleration dependence on blubber thickness

This example shows how to extract information from a sequence of simulations,
to create a graphical display that is not part of the default list. For
clarity, this is done with a loop rather than using e.g `lapply`.
```{r results="hide"}
library(whalestrike)
t <- seq(0, 1, length.out=500)
state <- c(xs=-1.5, vs=5, xw=0, vw=0)
beta <- seq(0.1, 0.3, length.out=100)
maxAccel <- rep(NA, length(beta))
ms <- 20e3
for (i in seq_along(beta)) {
    parms <- parameters(ms=ms, impactWidth=0.5, impactHeight=1,
                        lw=10,
                        alpha=0.025, Ealpha=2e7, theta=45,
                        beta=beta[i], Ebeta=6e5)
    sol <- strike(t, state, parms)
    maxAccel[i] <- max(abs(diff(sol$vw))) / (t[2] - t[1])
}
plot(beta, maxAccel, type="l", xlab=expression("Blubber thickness [m]"), ylab="Max. Acceleration [m/s^2]")
```

## Blubber-damage dependence on blubber thickness and ship speed

This example shows how to create a matrix of simulation results, in order to
display dependence of a result upon two parameters. Here, the display shows the
maximum compressive strain as a function of ship speed and blubber thickness.
Note that the contour lines are thickened when the strain exceeds an estimate
of the ratio of blubber ultimate tensile strength to blubber modulus.

```{r results="hide"}
library(whalestrike)
t <- seq(0, 1, length.out=500)
## Hint: making x and y of different lengths, to avoid row,col
## versus i,j confusion.
beta <- seq(0.1, 0.3, length.out=9)
speedK <- seq(2, 15, length.out=10) # in knots
speed <- 0.5144 * speedK
maxStrain <- matrix(NA, nrow=length(speed), ncol=length(beta))
for (i in seq_along(beta)) {
    for (j in seq_along(speed)) {
        state <- c(xs=-1.5, vs=speed[j], xw=0, vw=0)
        parms <- parameters(ms=ms, impactWidth=0.5, impactHeight=1,
                            lw=10,
                            alpha=0.025, Ealpha=2e7, theta=45,
                            beta=beta[i], Ebeta=6e5)
        sol <- strike(t, state, parms)
        maxStrain[j, i] <- max(sol$WCF$strain)
    }
}
danger <- 0.8 / 1.2
contour(speedK, beta, maxStrain, level=seq(0, danger, 0.1),
        xlab="Speed [knots]", ylab="Blubber thickness [m]")
contour(speedK, beta, maxStrain, level=seq(1, danger, -0.1), lwd=3, add=TRUE)
contour(speedK, beta, maxStrain, level=2/3, lwd=3, lty=2, add=TRUE)
## 2/3 = 0.8/1.2 is Grear et al. 2038 result (page 144, left column) that
## mean (seal) blubber strength is 0.8MPa, whereas mean (seal) blubber
## modulus is 1.2MPa.
mtext("Contours of max strain (dangerous if > 2/3)", side=3)
```


# Further reading

See [whalestrike](../help/whalestrike) for some references to the literature, and
individual help pages for details of the various functions in the package.

